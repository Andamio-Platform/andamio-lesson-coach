# Test Assignment Commitment Transaction Lifecycle

## Overview

You'll execute a COMMIT_TO_ASSIGNMENT transaction as a student, observe the onSubmit side effects, monitor blockchain confirmation, and verify the onConfirmation side effects complete successfully. The full cycle takes about 5-10 minutes depending on blockchain confirmation time.

## What Needs to be Tested

The assignment commitment transaction lifecycle includes these key components:

**Transaction Flow:**
- Build unsigned transaction via API endpoint
- Sign transaction in wallet
- Submit to blockchain
- Execute onSubmit side effect (status â†’ PENDING_TX_COMMITMENT)
- Wait for blockchain confirmation
- Execute onConfirmation side effect (status â†’ COMMITTED)

**Side Effects to Verify:**
- onSubmit: Updates database immediately after submission
- onConfirmation: Updates database with verified on-chain data including networkEvidenceHash

**Critical Success Points:**
- Transaction builds and submits successfully
- Database state changes correctly at each stage
- UI reflects committed state after confirmation

## Step-by-Step Instructions

### Step 1: Navigate to a Module Assignment

In the T3 App Template (localhost:3000):

1. Ensure you're logged in with your Cardano wallet
2. Navigate to a course you're enrolled in
3. Select a module that has an assignment
4. Click on the assignment to view details

Expected result: You see the assignment details page with a "Commit to Assignment" button available.

### Step 2: Open DevTools and Prepare to Monitor

1. Open Browser DevTools (F12)
2. Go to Network tab and filter for "Fetch/XHR"
3. Go to Console tab in another DevTools window/split
4. Keep both visible while executing the transaction

Expected result: DevTools is ready to capture all network activity.

### Step 3: Execute the Transaction

1. Click "Commit to Assignment" button
2. Review the transaction details in the modal
3. Click "Build Transaction"
4. Wait for unsigned transaction to be constructed
5. Your wallet will prompt you to sign
6. Sign the transaction in your wallet
7. Transaction is submitted to the blockchain

Expected result: You see success message: "Transaction submitted! TxHash: [hash]"

### Step 4: Observe onSubmit Side Effect

In the Network tab, find the PATCH request to:
```
/assignment-commitments/{courseNftPolicyId}/{moduleCode}/{yourAlias}/status
```

Check the request payload:
```json
{
  "networkStatus": "PENDING_TX_COMMITMENT",
  "pendingTxHash": "abc123..."
}
```

Expected result: Status code 200 OK, database record updated to PENDING_TX_COMMITMENT.

### Step 5: Monitor Blockchain Confirmation

1. Copy your transaction hash
2. Go to Cardano Preprod Explorer: https://preprod.cardanoscan.io
3. Paste your tx hash and search
4. Watch for confirmations (usually 1-3 minutes)

Expected result: Transaction shows as confirmed on Cardanoscan with block details.

### Step 6: Observe onConfirmation Side Effect

The transaction monitoring service polls for confirmations. When your transaction confirms, it:

1. Detects confirmation
2. Extracts on-chain data (including dataHash from the validator)
3. Executes onConfirmation side effect
4. Updates assignment commitment status to "COMMITTED"

In Prisma Studio (refresh the page):
- networkStatus: "COMMITTED"
- txHash: Your confirmed transaction hash  
- networkEvidenceHash: The dataHash from on-chain validator

Expected result: Database status changes from PENDING_TX_COMMITMENT to COMMITTED with networkEvidenceHash populated.

### Step 7: Verify in the UI

Refresh the assignment page in the T3 app. You should now see:
- Status changed from "Commit" to "Committed"
- Your commitment timestamp
- Option to "Update Assignment" (submit evidence)

Expected result: UI correctly shows you're committed to the assignment.

## Verification

You've successfully tested the assignment commitment lifecycle when:

- [ ] "Commit to Assignment" transaction built successfully
- [ ] Transaction was signed in wallet and submitted to blockchain
- [ ] onSubmit side effect executed (status â†’ PENDING_TX_COMMITMENT)
- [ ] Database shows pending status with tx hash
- [ ] Transaction confirmed on Cardano Preprod
- [ ] onConfirmation side effect executed (status â†’ COMMITTED)
- [ ] Database shows committed status with networkEvidenceHash
- [ ] UI reflects the committed state

## Understanding the Lifecycle Flow

```
User clicks "Commit to Assignment"
    â†“
Frontend: Build Transaction
    â†“
Backend: Create unsigned CBOR
    â†“
Frontend: User signs in wallet
    â†“
Frontend: Submit to blockchain
    â†“
Frontend: Execute onSubmit
    â†“
Backend: Update status to PENDING_TX_COMMITMENT
    â†“
[Wait for blockchain confirmation]
    â†“
Monitoring Service: Detect confirmation
    â†“
Monitoring Service: Execute onConfirmation
    â†“
Backend: Update status to COMMITTED + networkEvidenceHash
    â†“
Student sees "Committed" in UI
```

## Common Issues and Solutions

**Issue: "Commit to Assignment" button is disabled**
- Cause: You're not enrolled in the course
- Fix: Execute MINT_LOCAL_STATE transaction first (enroll)

**Issue: Transaction builds but fails to submit**
- Cause: Insufficient ADA in wallet or network issues
- Fix: Check you have at least 5-10 ADA in your Preprod wallet

**Issue: Transaction confirms but status stays PENDING_TX_COMMITMENT**
- Cause: Monitoring service isn't running or failed to execute onConfirmation
- Fix: Check DB API logs for monitoring service errors

**Issue: networkEvidenceHash is null after confirmation**
- Cause: Validator didn't include dataHash or monitoring service couldn't extract it
- Fix: Check transaction on Cardanoscan for withdrawals/metadata

## Tips from Experience

ðŸ’¡ Keep DevTools Network tab open to watch API calls in real-time

ðŸ’¡ Use Prisma Studio to observe database changes after submission and confirmation

ðŸ’¡ Don't click "Commit" twice - wait for confirmation if transaction is pending

ðŸ’¡ Check both frontend and backend logs for complete debugging picture

## What You've Built

You now understand the complete assignment commitment transaction lifecycle, from button click to confirmed on-chain record. You can trace how side effects update the database, verify the monitoring service works correctly, and debug issues when transactions don't complete as expected.

---

Part of What's New at Andamio > Andamio DB API and Template